<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Workish ‚Äî Tasker Dashboard</title>
  <meta name="description" content="Teen tasker dashboard: jobs near you + Workish Wallet + badges." />

  <style>
    :root{
      --forest:#003924; --ink:#0f2a1b; --sub:#224E3B;
      --cream:#F7F3EA; --off:#FAF8F2; --gold:#FFD66B;
      --line:rgba(0,0,0,.14);
      --font:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans";
      --r-sm:14px; --r-md:18px; --r-lg:24px;
      --shadow:0 10px 24px rgba(0,0,0,.10);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font); color:var(--ink); background:var(--cream);
      -webkit-font-smoothing:antialiased;
    }

    /* Background image + overlay (optional; matches your other pages) */
    body::before{
      content:""; position:fixed; inset:0; z-index:-2;
      background:url("/images/tasker.PNG") center/cover no-repeat;
      filter:brightness(.96) saturate(1.02) blur(.3px);
    }
    body::after{
      content:""; position:fixed; inset:0; z-index:-1;
      background:linear-gradient(180deg,
        rgba(0,57,36,.30) 0px,
        rgba(0,57,36,.24) 280px,
        rgba(247,243,234,.18) 60%,
        rgba(247,243,234,.22) 100%);
      pointer-events:none;
    }

    /* Header */
    .site-header{ position:sticky; top:0; z-index:50; background:#fff; border-bottom:1px solid var(--line); }
    .nav-wrap{ height:84px; display:flex; align-items:center; gap:18px; max-width:1100px; margin:0 auto; padding:0 16px; }
    .nav-brand{ display:flex; align-items:center; text-decoration:none; }
    .nav-logo{ max-height:86px; width:auto; display:block; object-fit:contain; }
    .nav-main{ display:flex; align-items:center; gap:6px; margin-left:8px; }
    .nav-item{ position:relative; }
    .nav-link{
      background:transparent; border:none; cursor:pointer; padding:10px 12px; border-radius:10px;
      font-weight:800; color:#0e1f17;
    }
    .submenu{
      position:absolute; top:100%; left:0; min-width:220px;
      background:#fff; border:1px solid var(--line); border-radius:12px;
      box-shadow:0 12px 28px rgba(0,0,0,.12); padding:8px; display:none;
    }
    .submenu a{ display:block; padding:10px 12px; border-radius:8px; color:var(--sub); text-decoration:none; font-weight:700; }
    .submenu a:hover{ background:var(--off); }
    @media(hover:hover){ .has-submenu:hover .submenu{ display:block; } }

    .nav-right{ margin-left:auto; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--line); background:#fff; border-radius:999px;
      padding:8px 12px; font-weight:900;
    }
    .btn-sm{
      border:1px solid var(--line); background:#fff; border-radius:999px;
      padding:8px 12px; font-weight:900; cursor:pointer;
    }
    .btn-sm.primary{ background:var(--forest); color:#fff; border-color:transparent; }
    .btn-sm[disabled]{ opacity:.6; cursor:not-allowed; }

    /* Page shell */
    .shell{ max-width:1100px; margin:0 auto; padding:22px 16px 88px; }
    .hero{
      color:#fff; text-shadow:0 3px 6px rgba(0,0,0,.40);
      display:flex; flex-direction:column; gap:10px; margin-bottom:14px;
    }
    .hero h1{ margin:0; font-size:clamp(26px,4.6vw,42px); line-height:1.12; letter-spacing:-.02em; font-weight:900; }
    .hero p{ margin:0; font-weight:700; }

    /* Tabs */
    .tabs{
      display:flex; gap:10px; flex-wrap:wrap;
      background:rgba(255,255,255,.85);
      border:1px solid var(--line);
      border-radius:999px;
      padding:8px;
      box-shadow:var(--shadow);
      width:max-content;
      max-width:100%;
      margin-bottom:16px;
    }
    .tab{
      border:none; cursor:pointer; font-weight:900;
      background:transparent; padding:10px 14px; border-radius:999px; color:#234337;
    }
    .tab.active{ background:var(--forest); color:#fff; }

    /* Cards + grid */
    .grid{ display:grid; gap:18px; grid-template-columns: 1.1fr 1fr; }
    @media(max-width:990px){ .grid{ grid-template-columns:1fr; } }
    .card{ background:#fff; border:1px solid var(--line); border-radius:var(--r-lg); box-shadow:var(--shadow); padding:16px; }
    .card h2, .card h3{ margin:0 0 10px; }

    .muted{ color:#51635b; font-weight:700; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border-radius:999px; padding:8px 12px;
      background:#f2f7f4; border:1px solid var(--line);
      font-weight:900;
    }

    /* ===== Wallet strip (matches your screenshot) ===== */
    .wallet-strip{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:18px;
      margin: 12px 0 18px;
    }
    @media(max-width: 980px){
      .wallet-strip{ grid-template-columns: 1fr; }
    }
    .wallet-card{ padding:18px; }

    .balances{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
      margin-top: 10px;
    }
    @media(max-width: 760px){
      .balances{ grid-template-columns: repeat(2, 1fr); }
    }
    .kpi{
      background:#fff;
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
    }
    .kpi .label{ font-size:.9rem; color:#6c7b75; font-weight:900; }
    .kpi .val{ font-weight:900; font-size:1.6rem; color:var(--forest); margin-top:4px; }
    .kpi .sub{ font-size:.9rem; color:#6c7b75; margin-top:2px; }

    .level-row{
      display:flex;
      align-items:center;
      gap:12px;
      margin-top: 14px;
    }
    .level-track{
      flex:1;
      height:10px;
      border-radius:999px;
      background:#ecf2ee;
      overflow:hidden;
    }
    .level-fill{
      height:100%;
      width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, var(--gold), #f0b500);
    }

    .badges{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
      margin-top: 10px;
    }
    @media(max-width: 760px){
      .badges{ grid-template-columns: repeat(3, 1fr); }
    }
    .badge{
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px 10px;
      background:#fff;
      text-align:center;
    }
    .badge .icon{ font-size:28px; line-height:1; }
    .badge .label{
      font-size:.9rem;
      margin-top:8px;
      font-weight:900;
      color:#6c7b75;
    }
    .badge.locked{
      opacity:.5;
      filter: grayscale(1);
    }

    /* Jobs list */
    .jobs{ display:grid; gap:10px; }
    .job{
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      background:#fff;
      display:grid;
      gap:8px;
    }
    .job .top{ display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center; }
    .job .title{ font-weight:900; font-size:1.05rem; }
    .job .meta{ display:flex; gap:8px; flex-wrap:wrap; color:#51635b; font-weight:800; }
    .job .desc{ color:#234337; font-weight:700; }
    .job .actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .btn{
      border:none; border-radius:999px; padding:10px 14px; font-weight:900; cursor:pointer;
      background:#fff; border:1px solid var(--line);
    }
    .btn.primary{ background:var(--forest); color:#fff; border-color:transparent; }
    .btn.danger{ background:#8b1b1b; color:#fff; border-color:transparent; }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; }

    /* Forms */
    .form-row{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media(max-width:820px){ .form-row{ grid-template-columns:1fr; } }
    label{ font-weight:900; display:block; margin:8px 0 6px; color:#173627; }
    .control{
      background:var(--off); border:1px solid var(--line);
      border-radius:14px; padding:12px 14px;
      display:flex; align-items:center; gap:10px;
    }
    .control input, .control textarea{
      border:none; outline:none; background:transparent; width:100%;
      font-size:15px; color:#1b2d23; font-weight:700;
    }
    .control textarea{ min-height:90px; resize:vertical; }

    /* Alerts */
    .error{ margin-top:10px; padding:10px 12px; border:1px solid #e7c5c5; background:#fff3f3; color:#7a1e1e; border-radius:10px; display:none; white-space:pre-wrap; }
    .ok{ margin-top:10px; padding:10px 12px; border:1px solid #cde4d6; background:#f3fbf7; color:#134b33; border-radius:10px; display:none; white-space:pre-wrap; }

    /* Footer-ish spacer for dock feel */
    .dock{
      position:fixed; left:0; right:0; bottom:0;
      background:#fff; border-top:1px solid var(--line);
      display:flex; gap:8px; flex-wrap:wrap; justify-content:center;
      padding:10px; z-index:60;
    }
    .dock .btn{ padding:10px 14px; }
  </style>
</head>

<body>
  <header class="site-header" role="banner">
    <div class="nav-wrap">
      <a class="nav-brand" href="/index.html" aria-label="Workish Home">
        <img src="/images/worklogo.PNG" alt="Workish" class="nav-logo">
      </a>

      <nav class="nav-main" aria-label="Primary">
        <div class="nav-item has-submenu">
          <button class="nav-link" aria-haspopup="true" aria-expanded="false">Join Workish</button>
          <div class="submenu">
            <a href="/taskers.html">For Taskers & Parents</a>
            <a href="/customers.html">For Customers</a>
            <a href="/safety.html">Safety & Oversight</a>
          </div>
        </div>
        <div class="nav-item has-submenu">
          <button class="nav-link" aria-haspopup="true" aria-expanded="false">About</button>
          <div class="submenu">
            <a href="/mission.html">Mission</a>
            <a href="/trust.html">Trust & verification</a>
            <a href="/faq.html">FAQ</a>
          </div>
        </div>
        <div class="nav-item has-submenu">
          <button class="nav-link" aria-haspopup="true" aria-expanded="false">Workish Wallet üí∞</button>
          <div class="submenu">
            <a href="/wallet.html">Wallet page (legacy)</a>
          </div>
        </div>
      </nav>

      <div class="nav-right">
        <span class="chip" id="whoChip">Not signed in</span>
        <button class="btn-sm primary" id="signInBtn">Sign in</button>
        <button class="btn-sm" id="signOutBtn" disabled>Sign out</button>
      </div>
    </div>
  </header>

  <main class="shell">
    <section class="hero">
      <h1>Tasker Dashboard</h1>
      <p>Find nearby jobs, earn badges, and increase your visibility.</p>
    </section>

    <div class="tabs" role="tablist" aria-label="Dashboard tabs">
      <button class="tab active" id="tabJobs" role="tab" aria-selected="true">Jobs</button>
      <button class="tab" id="tabWallet" role="tab" aria-selected="false">Wallet</button>
      <button class="tab" id="tabProfile" role="tab" aria-selected="false">Profile</button>
    </div>

    <!-- ===== JOBS VIEW ===== -->
    <section id="viewJobs">
      <div class="card">
        <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center;">
          <div>
            <h2 style="margin:0;">Jobs near you</h2>
            <div class="muted" id="zipLine">ZIP: ‚Äî</div>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
            <div class="pill">Visibility: <span id="visScore">‚Äî</span></div>
            <button class="btn" id="refreshJobsBtn">Refresh</button>
          </div>
        </div>

        <!-- ===== Top Wallet Strip (Balances + Badges) ===== -->
        <section class="wallet-strip" aria-label="Wallet summary">
          <div class="card wallet-card" style="box-shadow:none;">
            <h3 style="margin:0 0 6px;">Balances</h3>
            <div class="balances" id="balances"></div>

            <div class="level-row">
              <div class="level-left">
                <strong>Level <span id="levelNum">1</span></strong>
              </div>
              <div class="level-track" aria-label="Level progress">
                <div id="levelBar" class="level-fill" style="width:0%"></div>
              </div>
            </div>
          </div>

          <div class="card wallet-card" style="box-shadow:none;">
            <h3 style="margin:0 0 6px;">Badges</h3>
            <div class="badges" id="badges"></div>
          </div>
        </section>

        <div class="muted" style="margin-top:2px;">
          More completed jobs + badges = more visibility to customers.
        </div>

        <div id="jobsWrap" class="jobs" style="margin-top:14px;"></div>

        <div id="jobsEmpty" class="muted" style="display:none; margin-top:12px;">
          No open jobs found in your ZIP yet. Check back soon.
        </div>

        <div id="jobsErr" class="error"></div>
        <div id="jobsOk" class="ok"></div>
      </div>
    </section>

    <!-- ===== WALLET VIEW (full details / gamification) ===== -->
    <section id="viewWallet" style="display:none;">
      <div class="grid">
        <div class="card">
          <h2 style="margin:0 0 6px;">Workish Wallet</h2>
          <div class="muted">Build habits, grow savings, learn real-world money skills.</div>

          <div style="margin-top:12px;">
            <div class="balances" id="balances2"></div>
            <div class="level-row">
              <div><strong>Level <span id="levelNum2">1</span></strong></div>
              <div class="level-track"><div id="levelBar2" class="level-fill" style="width:0%"></div></div>
            </div>
          </div>

          <div class="ok" id="walletOk"></div>
          <div class="error" id="walletErr"></div>

          <details style="margin-top:12px;">
            <summary style="cursor:pointer; font-weight:900;">Demo actions (for testing)</summary>
            <div class="muted" style="margin-top:10px;">These simulate progress so you can see badges + visibility change.</div>
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
              <button class="btn secondary" id="demoCompleteJob">$60 ‚Äî Complete Job</button>
              <button class="btn secondary" id="demoPayout">$50 ‚Äî Payout to Wallet</button>
              <button class="btn secondary" id="demoSave20">Save $20</button>
              <button class="btn secondary" id="demoDonate5">Donate $5</button>
            </div>
          </details>
        </div>

        <div class="card">
          <h2 style="margin:0 0 6px;">Badges</h2>
          <div class="muted">Unlock badges to increase visibility.</div>
          <div class="badges" id="badges2"></div>
        </div>
      </div>
    </section>

    <!-- ===== PROFILE VIEW ===== -->
    <section id="viewProfile" style="display:none;">
      <div class="card">
        <h2 style="margin:0 0 6px;">Your Profile</h2>
        <div class="muted">This comes from <code>taskers/{uid}</code> in Firestore.</div>

        <div class="form-row" style="margin-top:10px;">
          <div>
            <label>Email</label>
            <div class="control"><input id="profEmail" disabled /></div>
          </div>
          <div>
            <label>ZIP</label>
            <div class="control"><input id="profZip" placeholder="e.g., 20169" /></div>
          </div>
        </div>

        <label style="margin-top:10px;">Interests (comma-separated)</label>
        <div class="control"><input id="profInterests" placeholder="Dog walking, Yardwork, Tutoring..." /></div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
          <button class="btn primary" id="saveProfileBtn">Save profile</button>
          <button class="btn" id="reloadProfileBtn">Reload</button>
        </div>

        <div id="profOk" class="ok"></div>
        <div id="profErr" class="error"></div>

        <hr style="border:none; border-top:1px solid var(--line); margin:16px 0;">

        <div class="muted">
          <strong>Note:</strong> For MVP, jobs are matched by exact ZIP. ‚ÄúNearby ZIP‚Äù matching comes next (ZIP-to-lat/long table or a lightweight geo index).
        </div>
      </div>
    </section>
  </main>

  <!-- Optional dock: quick refresh + wallet shortcut -->
  <div class="dock">
    <button class="btn" id="dockJobs">Jobs</button>
    <button class="btn" id="dockWallet">Wallet</button>
    <button class="btn" id="dockProfile">Profile</button>
    <button class="btn primary" id="dockRefresh">Refresh jobs</button>
  </div>

  <script type="module">
    // ===================== Firebase (same project as your other pages) =====================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      updateDoc,
      collection,
      query,
      where,
      orderBy,
      limit,
      getDocs,
      serverTimestamp,
      addDoc
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAsemgXgVrgclikdZbfNvaVaBWcvSQqQRY",
      authDomain: "workish-a70bb.firebaseapp.com",
      projectId: "workish-a70bb",
      storageBucket: "workish-a70bb.firebasestorage.app",
      messagingSenderId: "520376346783",
      appId: "1:520376346783:web:3fcbcb08edf86dd7e79aaa",
      measurementId: "G-CN0QH1BJEN"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ===================== UI helpers =====================
    const whoChip = document.getElementById("whoChip");
    const signInBtn = document.getElementById("signInBtn");
    const signOutBtn = document.getElementById("signOutBtn");

    const tabJobs = document.getElementById("tabJobs");
    const tabWallet = document.getElementById("tabWallet");
    const tabProfile = document.getElementById("tabProfile");
    const viewJobs = document.getElementById("viewJobs");
    const viewWallet = document.getElementById("viewWallet");
    const viewProfile = document.getElementById("viewProfile");

    const dockJobs = document.getElementById("dockJobs");
    const dockWallet = document.getElementById("dockWallet");
    const dockProfile = document.getElementById("dockProfile");
    const dockRefresh = document.getElementById("dockRefresh");

    const zipLine = document.getElementById("zipLine");
    const visScoreEl = document.getElementById("visScore");

    const jobsWrap = document.getElementById("jobsWrap");
    const jobsEmpty = document.getElementById("jobsEmpty");
    const refreshJobsBtn = document.getElementById("refreshJobsBtn");
    const jobsErr = document.getElementById("jobsErr");
    const jobsOk = document.getElementById("jobsOk");

    const profEmail = document.getElementById("profEmail");
    const profZip = document.getElementById("profZip");
    const profInterests = document.getElementById("profInterests");
    const saveProfileBtn = document.getElementById("saveProfileBtn");
    const reloadProfileBtn = document.getElementById("reloadProfileBtn");
    const profOk = document.getElementById("profOk");
    const profErr = document.getElementById("profErr");

    const walletOk = document.getElementById("walletOk");
    const walletErr = document.getElementById("walletErr");

    // Wallet UI targets (Jobs view)
    const balances1 = document.getElementById("balances");
    const levelNum1 = document.getElementById("levelNum");
    const levelBar1 = document.getElementById("levelBar");
    const badges1 = document.getElementById("badges");

    // Wallet UI targets (Wallet view)
    const balances2 = document.getElementById("balances2");
    const levelNum2 = document.getElementById("levelNum2");
    const levelBar2 = document.getElementById("levelBar2");
    const badges2 = document.getElementById("badges2");

    // Demo buttons
    const demoCompleteJob = document.getElementById("demoCompleteJob");
    const demoPayout = document.getElementById("demoPayout");
    const demoSave20 = document.getElementById("demoSave20");
    const demoDonate5 = document.getElementById("demoDonate5");

    function show(el, msg){
      el.textContent = msg;
      el.style.display = "block";
    }
    function hide(el){ el.style.display="none"; }
    function money(n){
      const v = Number(n || 0);
      return "$" + v.toLocaleString(undefined,{maximumFractionDigits:0});
    }

    function setActiveTab(which){
      const map = {
        jobs: [tabJobs, viewJobs],
        wallet: [tabWallet, viewWallet],
        profile: [tabProfile, viewProfile],
      };
      // reset
      [tabJobs, tabWallet, tabProfile].forEach(t=>t.classList.remove("active"));
      [viewJobs, viewWallet, viewProfile].forEach(v=>v.style.display="none");
      // set
      map[which][0].classList.add("active");
      map[which][1].style.display = "";
      // aria
      tabJobs.setAttribute("aria-selected", String(which==="jobs"));
      tabWallet.setAttribute("aria-selected", String(which==="wallet"));
      tabProfile.setAttribute("aria-selected", String(which==="profile"));
    }

    tabJobs.addEventListener("click", ()=>setActiveTab("jobs"));
    tabWallet.addEventListener("click", ()=>setActiveTab("wallet"));
    tabProfile.addEventListener("click", ()=>setActiveTab("profile"));
    dockJobs.addEventListener("click", ()=>setActiveTab("jobs"));
    dockWallet.addEventListener("click", ()=>setActiveTab("wallet"));
    dockProfile.addEventListener("click", ()=>setActiveTab("profile"));

    // ===================== State =====================
    let currentUser = null;
    let taskerProfile = null;

    // Wallet state stored under taskers/{uid}.wallet
    const defaultWallet = () => ({
      balanceAvailable: 0,
      pendingPayouts: 0,
      totalEarned: 0,
      savedTotal: 0,
      donatedTotal: 0,
      goals: [
        { id: "g1", name: "AirPods", target: 150, saved: 0 },
        { id: "g2", name: "Bike Fund", target: 300, saved: 0 }
      ],
      jobsCompleted: 0,
      weeklyStreak: 0,
      lastStreakWeek: null
    });

    // ===================== Badges + Level + Visibility (core gamification) =====================
    function weekOf(ts){
      const d=new Date(ts);
      const first=new Date(d.getFullYear(),0,1);
      return Math.floor((d-first)/(1000*60*60*24*7));
    }

    function computeBadges(wallet){
      const goals = Array.isArray(wallet.goals) ? wallet.goals : [];
      const anyGoal = goals.length > 0;
      const completedGoal = goals.some(g => (Number(g.saved||0) >= Number(g.target||0)) && Number(g.target||0) > 0);

      return {
        firstJob: Number(wallet.jobsCompleted||0) >= 1,
        tenJobs: Number(wallet.jobsCompleted||0) >= 10,
        hundredSaved: Number(wallet.savedTotal||0) >= 100,
        communityHero: Number(wallet.donatedTotal||0) >= 5,
        goalSetter: anyGoal,
        goalCrusher: completedGoal
      };
    }

    function badgeCount(b){
      return Object.values(b).filter(Boolean).length;
    }

    function computeLevel(wallet){
      // Simple XP model (tweak later)
      const jobs = Number(wallet.jobsCompleted||0);
      const saved = Number(wallet.savedTotal||0);
      const donated = Number(wallet.donatedTotal||0);

      const xp =
        (jobs * 12) +              // jobs matter most
        Math.floor(saved / 5) +    // saving matters
        Math.floor(donated * 3);   // giving matters

      const level = Math.max(1, Math.floor(xp / 100) + 1);
      const pct = Math.min(100, xp % 100); // progress to next level
      return { level, pct, xp };
    }

    function computeVisibility(wallet){
      const b = computeBadges(wallet);
      const bc = badgeCount(b);
      const { level } = computeLevel(wallet);
      const jobs = Number(wallet.jobsCompleted||0);
      const streak = Number(wallet.weeklyStreak||0);

      let score = 50
        + (jobs * 2)
        + (bc * 6)
        + (level * 3)
        + (streak * 4);

      score = Math.max(0, Math.min(100, Math.round(score)));
      return score;
    }

    function badgeIcon(key){
      const map = {
        firstJob: "üíº",
        hundredSaved: "üè¶",
        tenJobs: "üîü",
        communityHero: "ü§ù",
        goalCrusher: "üéØ",
        goalSetter: "üß≠"
      };
      return map[key] || "‚≠ê";
    }

    function renderBalances(target, wallet){
      target.innerHTML = "";
      const items = [
        { label:"Available", val: wallet.balanceAvailable, sub:"Spendable" },
        { label:"Pending", val: wallet.pendingPayouts, sub:"Payouts due" },
        { label:"Saved", val: wallet.savedTotal, sub:"Across goals" },
        { label:"Total Earned", val: wallet.totalEarned, sub:"All time" },
      ];
      items.forEach(it=>{
        const el=document.createElement("div");
        el.className="kpi";
        el.innerHTML = `
          <div class="label">${it.label}</div>
          <div class="val">${money(it.val)}</div>
          <div class="sub">${it.sub}</div>
        `;
        target.appendChild(el);
      });
    }

    function renderBadges(target, wallet){
      target.innerHTML = "";
      const b = computeBadges(wallet);
      const all = [
        { key:"firstJob", label:"First Job" },
        { key:"hundredSaved", label:"$100 Saved" },
        { key:"tenJobs", label:"10 Jobs" },
        { key:"communityHero", label:"Community Hero" },
        { key:"goalCrusher", label:"Goal Crusher" },
        { key:"goalSetter", label:"Goal Setter" },
      ];
      all.forEach(x=>{
        const el=document.createElement("div");
        el.className = "badge" + (b[x.key] ? "" : " locked");
        el.innerHTML = `
          <div class="icon">${badgeIcon(x.key)}</div>
          <div class="label">${x.label}</div>
        `;
        target.appendChild(el);
      });
    }

    function renderWalletEverywhere(){
      if(!taskerProfile) return;
      const wallet = taskerProfile.wallet || defaultWallet();

      renderBalances(balances1, wallet);
      renderBadges(badges1, wallet);

      renderBalances(balances2, wallet);
      renderBadges(badges2, wallet);

      const { level, pct } = computeLevel(wallet);
      levelNum1.textContent = String(level);
      levelBar1.style.width = pct + "%";
      levelNum2.textContent = String(level);
      levelBar2.style.width = pct + "%";

      const vis = computeVisibility(wallet);
      visScoreEl.textContent = String(vis);
    }

    // ===================== Firestore: load/save tasker profile =====================
    async function loadTaskerProfile(uid){
      const ref = doc(db, "taskers", uid);
      const snap = await getDoc(ref);
      if(!snap.exists()){
        // Create a minimal profile if missing (safe MVP)
        const email = currentUser?.email || null;
        const seed = {
          uid,
          email,
          role: "teenTasker",
          createdAt: serverTimestamp(),
          zip: null,
          interests: [],
          wallet: defaultWallet(),
          visibilityScore: 50
        };
        await setDoc(ref, seed, { merge:true });
        return seed;
      }
      return snap.data();
    }

    async function saveTaskerProfilePatch(uid, patch){
      const ref = doc(db, "taskers", uid);
      await setDoc(ref, patch, { merge:true });
    }

    async function saveWallet(walletPatch){
      if(!currentUser) return;
      const uid = currentUser.uid;

      const existing = taskerProfile?.wallet || defaultWallet();
      const next = { ...existing, ...walletPatch };

      // Update streak if they "saved this week" (basic: saving triggers streak)
      // We only adjust streak in demoSave20 for now.

      const vis = computeVisibility(next);
      await setDoc(doc(db, "taskers", uid), {
        wallet: next,
        visibilityScore: vis,
        updatedAt: serverTimestamp()
      }, { merge:true });

      // reload local state
      taskerProfile = { ...taskerProfile, wallet: next, visibilityScore: vis };
      renderWalletEverywhere();
    }

    // ===================== Jobs: query tasks by ZIP =====================
    async function loadJobs(){
      hide(jobsErr); hide(jobsOk);
      jobsWrap.innerHTML = "";
      jobsEmpty.style.display = "none";

      if(!currentUser) {
        jobsEmpty.style.display = "";
        jobsEmpty.textContent = "Sign in to see jobs.";
        return;
      }
      if(!taskerProfile) return;

      const zip = (taskerProfile.zip || "").trim();
      zipLine.textContent = "ZIP: " + (zip || "‚Äî (set your ZIP in Profile)");

      if(!zip){
        jobsEmpty.style.display = "";
        jobsEmpty.textContent = "Set your ZIP in Profile to see nearby jobs.";
        return;
      }

      try{
        // MVP: exact ZIP match. Next step: nearby ZIPs via a zip->lat/lng table or geohash.
        const qy = query(
          collection(db, "tasks"),
          where("zip", "==", zip),
          orderBy("createdAt", "desc"),
          limit(25)
        );
        const snaps = await getDocs(qy);
        const docs = [];
        snaps.forEach(s=>docs.push({ id:s.id, ...s.data() }));

        if(docs.length === 0){
          jobsEmpty.style.display = "";
          return;
        }

        docs.forEach(t => renderJobCard(t));
      }catch(e){
        show(jobsErr, e?.message || String(e));
      }
    }

    function safeStr(v){
      if(v === null || v === undefined) return "";
      return String(v);
    }

    function renderJobCard(t){
      const title = safeStr(t.title || t.category || "Task");
      const pay = (t.pay != null) ? money(t.pay) : "‚Äî";
      const zip = safeStr(t.zip || "‚Äî");
      const when = t.createdAt?.toDate ? t.createdAt.toDate().toLocaleString() : "";

      const el = document.createElement("div");
      el.className = "job";
      el.innerHTML = `
        <div class="top">
          <div class="title">${title}</div>
          <div class="pill">Pay: ${pay}</div>
        </div>
        <div class="meta">
          <span>ZIP: ${zip}</span>
          ${when ? `<span>Posted: ${when}</span>` : ``}
        </div>
        <div class="desc">${safeStr(t.details || t.description || "No details provided.")}</div>
        <div class="actions">
          <button class="btn primary">Express interest</button>
          <button class="btn">Save</button>
        </div>
        <div class="muted" style="font-size:.92rem;">
          (MVP) ‚ÄúExpress interest‚Äù creates a simple record. Bidding / messaging comes next.
        </div>
      `;

      const [btnInterest, btnSave] = el.querySelectorAll("button");

      btnInterest.addEventListener("click", async ()=>{
        hide(jobsErr); hide(jobsOk);
        if(!currentUser) return show(jobsErr, "Please sign in first.");

        try{
          // Minimal ‚Äúinterest‚Äù record (you can later upgrade to /tasks/{id}/bids)
          await addDoc(collection(db, "taskInterests"), {
            taskId: t.id,
            taskZip: t.zip || null,
            taskTitle: t.title || t.category || "Task",
            taskerUid: currentUser.uid,
            taskerEmail: currentUser.email || null,
            createdAt: serverTimestamp()
          });
          show(jobsOk, "Interest sent! (Saved to taskInterests)");
        }catch(e){
          show(jobsErr, e?.message || String(e));
        }
      });

      btnSave.addEventListener("click", ()=>{
        show(jobsOk, "Saved locally (UI only). You can wire this to Firestore later.");
      });

      jobsWrap.appendChild(el);
    }

    refreshJobsBtn.addEventListener("click", loadJobs);
    dockRefresh.addEventListener("click", loadJobs);

    // ===================== Profile UI =====================
    async function paintProfileUI(){
      if(!currentUser || !taskerProfile) return;

      profEmail.value = currentUser.email || "";
      profZip.value = taskerProfile.zip || "";
      profInterests.value = Array.isArray(taskerProfile.interests) ? taskerProfile.interests.join(", ") : "";
    }

    reloadProfileBtn.addEventListener("click", async ()=>{
      hide(profOk); hide(profErr);
      if(!currentUser) return show(profErr, "Sign in first.");
      try{
        taskerProfile = await loadTaskerProfile(currentUser.uid);
        await paintProfileUI();
        renderWalletEverywhere();
        await loadJobs();
        show(profOk, "Profile reloaded.");
      }catch(e){
        show(profErr, e?.message || String(e));
      }
    });

    saveProfileBtn.addEventListener("click", async ()=>{
      hide(profOk); hide(profErr);
      if(!currentUser) return show(profErr, "Sign in first.");

      const zip = (profZip.value || "").trim();
      const interests = (profInterests.value || "")
        .split(",")
        .map(s=>s.trim())
        .filter(Boolean);

      try{
        await saveTaskerProfilePatch(currentUser.uid, {
          zip: zip || null,
          interests,
          updatedAt: serverTimestamp()
        });
        taskerProfile = { ...taskerProfile, zip: zip || null, interests };
        zipLine.textContent = "ZIP: " + (zip || "‚Äî (set your ZIP in Profile)");
        show(profOk, "Saved.");
        await loadJobs();
      }catch(e){
        show(profErr, e?.message || String(e));
      }
    });

    // ===================== Demo actions (wallet + badges) =====================
    demoCompleteJob.addEventListener("click", async ()=>{
      hide(walletOk); hide(walletErr);
      if(!currentUser) return show(walletErr, "Sign in first.");

      const w = taskerProfile?.wallet || defaultWallet();
      const nextJobs = Number(w.jobsCompleted||0) + 1;

      // Completing a job adds pending payout + earned
      await saveWallet({
        jobsCompleted: nextJobs,
        pendingPayouts: Number(w.pendingPayouts||0) + 60,
        totalEarned: Number(w.totalEarned||0) + 60
      });
      show(walletOk, "Job completed + $60 pending payout added.");
    });

    demoPayout.addEventListener("click", async ()=>{
      hide(walletOk); hide(walletErr);
      if(!currentUser) return show(walletErr, "Sign in first.");

      const w = taskerProfile?.wallet || defaultWallet();
      const payout = Math.min(50, Number(w.pendingPayouts||0));
      if(payout <= 0) return show(walletErr, "No pending payouts to move.");

      await saveWallet({
        pendingPayouts: Number(w.pendingPayouts||0) - payout,
        balanceAvailable: Number(w.balanceAvailable||0) + payout
      });
      show(walletOk, `Moved ${money(payout)} from pending to available.`);
    });

    demoSave20.addEventListener("click", async ()=>{
      hide(walletOk); hide(walletErr);
      if(!currentUser) return show(walletErr, "Sign in first.");

      const w = taskerProfile?.wallet || defaultWallet();
      if(Number(w.balanceAvailable||0) < 20) return show(walletErr, "Not enough available balance. (Try payout first.)");

      const wk = weekOf(Date.now());
      let weeklyStreak = Number(w.weeklyStreak||0);
      const last = w.lastStreakWeek;

      // If saving for the first time this week, update streak
      if(last !== wk){
        if(last === wk-1) weeklyStreak += 1;  // continue streak
        else weeklyStreak = 1;                // start/reset streak
      }

      await saveWallet({
        balanceAvailable: Number(w.balanceAvailable||0) - 20,
        savedTotal: Number(w.savedTotal||0) + 20,
        weeklyStreak,
        lastStreakWeek: wk
      });
      show(walletOk, "Saved $20. Streak updated.");
    });

    demoDonate5.addEventListener("click", async ()=>{
      hide(walletOk); hide(walletErr);
      if(!currentUser) return show(walletErr, "Sign in first.");

      const w = taskerProfile?.wallet || defaultWallet();
      if(Number(w.balanceAvailable||0) < 5) return show(walletErr, "Not enough available balance.");

      await saveWallet({
        balanceAvailable: Number(w.balanceAvailable||0) - 5,
        donatedTotal: Number(w.donatedTotal||0) + 5
      });
      show(walletOk, "Donated $5. Community Hero unlocks at $5+.");
    });

    // ===================== Auth (simple prompt login for MVP) =====================
    signInBtn.addEventListener("click", async ()=>{
      // Simple prompt flow for MVP. You can swap to a dedicated /tasker-login.html later.
      const email = prompt("Tasker email:");
      if(!email) return;
      const password = prompt("Password:");
      if(!password) return;

      try{
        await signInWithEmailAndPassword(auth, email.trim(), password);
      }catch(e){
        alert(e?.message || String(e));
      }
    });

    signOutBtn.addEventListener("click", async ()=>{
      try{ await signOut(auth); }catch(e){ alert(e?.message || String(e)); }
    });

    onAuthStateChanged(auth, async (user)=>{
      currentUser = user;

      hide(jobsErr); hide(jobsOk);
      hide(profOk); hide(profErr);
      hide(walletOk); hide(walletErr);

      if(!user){
        whoChip.textContent = "Not signed in";
        signOutBtn.disabled = true;
        signInBtn.disabled = false;

        taskerProfile = null;
        zipLine.textContent = "ZIP: ‚Äî";
        visScoreEl.textContent = "‚Äî";
        jobsWrap.innerHTML = "";
        jobsEmpty.style.display = "";
        jobsEmpty.textContent = "Sign in to see jobs and wallet.";

        // clear wallet UI
        balances1.innerHTML = ""; badges1.innerHTML = "";
        balances2.innerHTML = ""; badges2.innerHTML = "";
        levelNum1.textContent = "1"; levelBar1.style.width = "0%";
        levelNum2.textContent = "1"; levelBar2.style.width = "0%";
        return;
      }

      whoChip.textContent = "Signed in: " + (user.email || user.uid);
      signOutBtn.disabled = false;
      signInBtn.disabled = true;

      try{
        taskerProfile = await loadTaskerProfile(user.uid);

        // Ensure wallet exists
        if(!taskerProfile.wallet){
          taskerProfile.wallet = defaultWallet();
          await saveTaskerProfilePatch(user.uid, { wallet: taskerProfile.wallet });
        }

        // Paint UI
        await paintProfileUI();
        renderWalletEverywhere();

        // Show jobs by default
        setActiveTab("jobs");
        await loadJobs();
      }catch(e){
        show(jobsErr, e?.message || String(e));
      }
    });

    // Initial dock buttons state
    setActiveTab("jobs");
  </script>
</body>
</html>
