<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Workish Admin — Parent Consents</title>
  <meta name="description" content="Admin review for Workish parent consent submissions." />

  <style>
    :root{
      --forest:#003924; --ink:#0f2a1b; --sub:#224E3B;
      --cream:#F7F3EA; --off:#FAF8F2; --gold:#FFD66B;
      --line:rgba(0,0,0,.14);
      --font:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans";
      --r-sm:14px; --r-lg:22px;
      --shadow:0 10px 24px rgba(0,0,0,.10);
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:var(--font); color:var(--ink); background:var(--cream); }
    header{
      position:sticky; top:0; z-index:20;
      background:#fff; border-bottom:1px solid var(--line);
    }
    .wrap{ max-width:1100px; margin:0 auto; padding:16px; }
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{ display:flex; align-items:center; gap:12px; }
    .brand img{ height:52px; width:auto; }
    h1{ margin:0; font-size:1.25rem; }
    .btn{
      border:1px solid var(--line);
      background:#fff;
      border-radius:12px;
      padding:10px 12px;
      font-weight:800;
      cursor:pointer;
    }
    .btn.primary{ background:var(--forest); color:#fff; border-color:transparent; }
    .btn.danger{ background:#7a1e1e; color:#fff; border-color:transparent; }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; }

    .card{
      background:#fff; border:1px solid var(--line); border-radius:var(--r-lg); box-shadow:var(--shadow);
      padding:16px;
      margin-top:14px;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .muted{ color:#3f5b4d; font-weight:700; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      background:var(--off); border:1px solid var(--line);
      font-weight:800; font-size:.92rem;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media(max-width:900px){ .grid{ grid-template-columns:1fr; } }
    .field{ padding:10px 12px; border:1px solid rgba(0,0,0,.08); border-radius:14px; background:var(--off); }
    .field .k{ font-weight:900; color:#173627; margin-bottom:4px; }
    .field .v{ color:#1b2d23; word-break:break-word; }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .hr{ height:1px; background:rgba(0,0,0,.08); margin:14px 0; }

    .error{ display:none; margin-top:12px; padding:10px 12px; border-radius:12px; border:1px solid #e7c5c5; background:#fff3f3; color:#7a1e1e; font-weight:700; }
    .ok{ display:none; margin-top:12px; padding:10px 12px; border-radius:12px; border:1px solid #cde4d6; background:#f3fbf7; color:#134b33; font-weight:700; }

    input{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 10px;
      font-size:14px;
      width:240px;
      background:#fff;
    }
    .small{ font-size:.92rem; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .sr-only{position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <header>
    <div class="wrap top">
      <div class="brand">
        <img src="/images/worklogo.PNG" alt="Workish">
        <div>
          <h1>Admin — Parent Consents</h1>
          <div class="muted small">Review & approve/reject consent submissions.</div>
        </div>
      </div>
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <span id="who" class="pill">Not signed in</span>
        <button class="btn" id="signOutBtn" hidden>Sign out</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="card">
      <div class="row">
        <div>
          <div class="pill">Step 1: Admin Login</div>
          <div class="muted small" style="margin-top:6px;">
            Use your admin email/password (Firebase Auth). If you’re not allowlisted in <span class="mono">admins/{uid}</span>, you won’t see any data.
          </div>
        </div>

        <form id="loginForm" style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <label class="sr-only" for="email">Email</label>
          <input id="email" type="email" placeholder="admin@email.com" required />
          <label class="sr-only" for="password">Password</label>
          <input id="password" type="password" placeholder="password" required />
          <button class="btn primary" id="loginBtn" type="submit">Sign in</button>
        </form>
      </div>

      <div id="err" class="error"></div>
      <div id="ok" class="ok"></div>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <div class="pill">Step 2: Submissions</div>
          <div class="muted small" style="margin-top:6px;">
            Approving generates an invite code and stores it in <span class="mono">teenInvites/{code}</span>.
          </div>
        </div>
        <button class="btn" id="refreshBtn" disabled>Refresh</button>
      </div>

      <div class="hr"></div>
      <div id="list"></div>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      query,
      orderBy,
      getDocs,
      doc,
      updateDoc,
      setDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    // ✅ Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAsemgXgVrgclikdZbfNvaVaBWcvSQqQRY",
      authDomain: "workish-a70bb.firebaseapp.com",
      projectId: "workish-a70bb",
      storageBucket: "workish-a70bb.firebasestorage.app",
      messagingSenderId: "520376346783",
      appId: "1:520376346783:web:3fcbcb08edf86dd7e79aaa",
      measurementId: "G-CN0QH1BJEN"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const who = document.getElementById('who');
    const signOutBtn = document.getElementById('signOutBtn');
    const loginForm = document.getElementById('loginForm');
    const emailEl = document.getElementById('email');
    const pwEl = document.getElementById('password');
    const loginBtn = document.getElementById('loginBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const list = document.getElementById('list');
    const err = document.getElementById('err');
    const ok = document.getElementById('ok');

    function showError(msg){ err.textContent = msg; err.style.display='block'; ok.style.display='none'; }
    function showOk(msg){ ok.textContent = msg; ok.style.display='block'; err.style.display='none'; }
    function clearMsgs(){ err.style.display='none'; ok.style.display='none'; }

    function genInviteCode(){
      // simple readable code
      const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      let out = "";
      for(let i=0;i<6;i++) out += chars[Math.floor(Math.random()*chars.length)];
      return out;
    }

    async function loadConsents(){
      list.innerHTML = '<div class="muted">Loading…</div>';
      try{
        const q = query(collection(db, "parentConsents"), orderBy("createdAt", "desc"));
        const snap = await getDocs(q);
        if(snap.empty){
          list.innerHTML = '<div class="muted">No submissions yet.</div>';
          return;
        }

        const items = [];
        snap.forEach(d => items.push({ id: d.id, ...d.data() }));

        list.innerHTML = '';
        for(const item of items){
          const status = item.status || "submitted";
          const interests = Array.isArray(item.taskInterests) ? item.taskInterests.join(", ") : (item.taskInterests || "");
          const inviteCode = item.inviteCode || "";

          const card = document.createElement('div');
          card.className = 'card';
          card.style.marginTop = '12px';

          card.innerHTML = `
            <div class="row">
              <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                <span class="pill">Status: <span class="mono">${status}</span></span>
                ${inviteCode ? `<span class="pill">Invite: <span class="mono">${inviteCode}</span></span>` : ``}
                <span class="pill">ZIP: <span class="mono">${item.teenZip || ""}</span></span>
              </div>
              <div class="muted small">Doc: <span class="mono">${item.id}</span></div>
            </div>

            <div class="grid">
              <div class="field"><div class="k">Parent</div><div class="v">${item.parentName || ""} (${item.relationship || ""})</div></div>
              <div class="field"><div class="k">Teen</div><div class="v">${item.teenName || ""} — DOB: ${item.teenDob || ""}</div></div>
              <div class="field"><div class="k">Parent Email</div><div class="v">${item.parentEmail || ""}</div></div>
              <div class="field"><div class="k">Parent Phone</div><div class="v">${item.parentPhone || ""}</div></div>
              <div class="field" style="grid-column:1/-1;"><div class="k">Interests</div><div class="v">${interests}</div></div>
              ${item.notes ? `<div class="field" style="grid-column:1/-1;"><div class="k">Notes</div><div class="v">${item.notes}</div></div>` : ``}
            </div>

            <div class="actions">
              <button class="btn primary" data-action="approve" ${status==="approved" ? "disabled" : ""}>Approve + Generate Invite</button>
              <button class="btn danger" data-action="reject" ${status==="rejected" ? "disabled" : ""}>Reject</button>
              ${inviteCode ? `<a class="btn" href="/tasker-signup.html?code=${inviteCode}" target="_blank" rel="noopener">Open teen signup link</a>` : ``}
            </div>

            <div class="muted small" style="margin-top:10px;">
              After approval, manually email/text the teen signup link to the parent for now.
            </div>
          `;

          card.querySelectorAll('button[data-action]').forEach(btn=>{
            btn.addEventListener('click', async ()=>{
              clearMsgs();
              btn.disabled = true;
              try{
                const ref = doc(db, "parentConsents", item.id);

                if(btn.dataset.action === "approve"){
                  const code = item.inviteCode || genInviteCode();

                  // Create invite doc (teenInvites/{code})
                  await setDoc(doc(db, "teenInvites", code), {
                    code,
                    parentConsentId: item.id,
                    teenName: item.teenName || "",
                    teenZip: item.teenZip || "",
                    taskInterests: Array.isArray(item.taskInterests) ? item.taskInterests : [],
                    status: "active",
                    createdAt: serverTimestamp()
                  }, { merge: true });

                  // Update consent status + inviteCode
                  await updateDoc(ref, {
                    status: "approved",
                    inviteCode: code,
                    reviewedAt: serverTimestamp()
                  });

                  showOk(`Approved. Invite code: ${code}`);
                }

                if(btn.dataset.action === "reject"){
                  await updateDoc(ref, {
                    status: "rejected",
                    reviewedAt: serverTimestamp()
                  });
                  showOk("Rejected.");
                }

                await loadConsents();
              }catch(ex){
                console.error(ex);
                showError("Admin action failed. Are you allowlisted as admin in Firestore (admins/{uid})?");
              }finally{
                btn.disabled = false;
              }
            });
          });

          list.appendChild(card);
        }
      }catch(ex){
        console.error(ex);
        list.innerHTML = '';
        showError("Could not load submissions. You must be signed in AND in admins/{uid}.");
      }
    }

    loginForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      clearMsgs();
      loginBtn.disabled = true;
      try{
        await signInWithEmailAndPassword(auth, emailEl.value.trim(), pwEl.value);
        showOk("Signed in.");
      }catch(ex){
        console.error(ex);
        showError("Login failed. Check email/password.");
      }finally{
        loginBtn.disabled = false;
      }
    });

    refreshBtn.addEventListener('click', loadConsents);

    signOutBtn.addEventListener('click', async ()=>{
      await signOut(auth);
    });

    onAuthStateChanged(auth, async (user)=>{
      clearMsgs();
      if(user){
        who.textContent = `Signed in: ${user.email}`;
        signOutBtn.hidden = false;
        refreshBtn.disabled = false;
        await loadConsents();
      }else{
        who.textContent = "Not signed in";
        signOutBtn.hidden = true;
        refreshBtn.disabled = true;
        list.innerHTML = '<div class="muted">Sign in to view submissions.</div>';
      }
    });
  </script>
</body>
</html>
